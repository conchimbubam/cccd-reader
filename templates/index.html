<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc thông tin CCCD</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f7fa;
            color: #333;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 { 
            text-align: center; 
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .upload-area { 
            border: 2px dashed #ccc; 
            padding: 30px; 
            text-align: center; 
            margin: 20px 0;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        .upload-area:hover { 
            border-color: #007bff; 
            background-color: #f0f7ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e6f2ff;
        }
        .paste-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            background-color: #f8f9fa;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .paste-area:hover, .paste-area.paste-active {
            border-color: #007bff;
            background-color: #f0f7ff;
        }
        .url-input-area {
            margin: 20px 0;
        }
        .url-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .url-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        #imagePreview, #pasteImagePreview { 
            max-width: 100%; 
            max-height: 300px; 
            margin-top: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        button { 
            padding: 12px 24px; 
            margin: 10px 5px; 
            cursor: pointer; 
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        #processBtn { 
            background: #007bff; 
            color: white; 
            width: 100%;
            margin-top: 20px;
        }
        #processBtn:hover { 
            background: #0069d9; 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
        #processBtn:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .hidden { display: none; }
        .loading { 
            text-align: center; 
            padding: 30px; 
            color: #007bff; 
        }
        .spinner {
            border: 4px solid rgba(0, 123, 255, 0.2);
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .copy-btn { 
            background: #28a745; 
            color: white; 
            margin-bottom: 15px; 
        }
        .copy-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        .clear-btn {
            background: #dc3545;
            color: white;
            margin-bottom: 15px;
        }
        .clear-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        .error { 
            color: #dc3545; 
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .info-text {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        .preview-container {
            text-align: center;
        }
        .results-container {
            margin-top: 30px;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .results-table th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .results-table tr:last-child td {
            border-bottom: none;
        }
        .results-table tr:hover {
            background-color: #f8f9fa;
        }
        .no-results {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-style: italic;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .action-buttons button {
            flex: 1;
        }
        .image-thumbnail {
            width: 80px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        .selection-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .paste-instruction {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Đọc thông tin căn cước công dân</h1>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" data-tab="upload">Tải ảnh lên</button>
                <button class="tab" data-tab="url">Nhập URL ảnh</button>
                <button class="tab" data-tab="paste">Dán ảnh từ clipboard</button>
            </div>
            
            <div class="tab-content active" id="upload-tab">
                <div class="upload-area" id="uploadArea">
                    <p>Kéo thả ảnh vào đây hoặc click để chọn ảnh</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <div class="preview-container">
                        <img id="imagePreview" class="hidden">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="url-tab">
                <div class="url-input-area">
                    <input type="text" class="url-input" id="urlInput" placeholder="Dán URL ảnh vào đây...">
                    <p class="info-text">Hỗ trợ các định dạng ảnh phổ biến: JPG, PNG, WebP</p>
                    <button id="loadUrlBtn" style="width: 100%; margin-top: 10px;">Tải ảnh từ URL</button>
                    <div class="preview-container">
                        <img id="urlImagePreview" class="hidden">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="paste-tab">
                <div class="paste-area" id="pasteArea" tabindex="0">
                    <p>Nhấn vào đây và dán ảnh từ clipboard (Ctrl+V)</p>
                    <p class="paste-instruction">Sao chép ảnh từ Zalo, Facebook hoặc ứng dụng khác và dán vào đây</p>
                    <div class="preview-container">
                        <img id="pasteImagePreview" class="hidden">
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="processImage()" id="processBtn" disabled>Đọc thông tin với AI</button>
            <button onclick="addMoreImages()" id="addMoreBtn">Thêm ảnh khác</button>
        </div>
        
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Đang phân tích ảnh với Gemini AI...</p>
        </div>
        
        <div class="results-container">
            <div class="results-header">
                <h2>Kết quả đọc thông tin</h2>
                <div>
                    <button class="copy-btn" onclick="copySelectedResults()">Sao chép mục đã chọn</button>
                    <button class="clear-btn" onclick="clearAllResults()">Xóa tất cả</button>
                </div>
            </div>
            
            <div class="select-all-container">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                <label for="selectAllCheckbox">Chọn tất cả</label>
            </div>
            
            <div id="resultsTableContainer">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">Chọn</th>
                            <th>STT</th>
                            <th>Ảnh</th>
                            <th>Số CCCD</th>
                            <th>Họ và tên</th>
                            <th>Ngày sinh</th>
                            <th>Giới tính</th>
                            <th>Quốc tịch</th>
                            <th>Quê quán</th>
                            <th>Địa chỉ thường trú</th>
                            <th>Ngày cấp</th>
                            <th>Nơi cấp</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="12" class="no-results">Chưa có kết quả nào. Hãy tải lên ảnh CCCD để bắt đầu.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for image preview -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <img id="modalImage" class="modal-image">
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const urlInput = document.getElementById('urlInput');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const urlImagePreview = document.getElementById('urlImagePreview');
        const pasteArea = document.getElementById('pasteArea');
        const pasteImagePreview = document.getElementById('pasteImagePreview');
        const processBtn = document.getElementById('processBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const loading = document.getElementById('loading');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        let currentImage = null;
        let currentImageType = null; // 'file', 'url', or 'paste'
        let allResults = [];

        // Xử lý chuyển tab
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Cập nhật tab active
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Hiển thị nội dung tab tương ứng
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
                
                // Reset trạng thái nếu không có ảnh
                if (!currentImage) {
                    processBtn.disabled = true;
                }
            });
        });

        // Xử lý kéo thả cho tab tải lên
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        // Xử lý tải ảnh từ URL
        loadUrlBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (!url) {
                showMessage('Vui lòng nhập URL ảnh', 'error');
                return;
            }
            
            loadImageFromUrl(url);
        });

        // Cho phép nhấn Enter để tải ảnh từ URL
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadImageFromUrl(urlInput.value.trim());
            }
        });

        // Xử lý dán ảnh từ clipboard
        pasteArea.addEventListener('click', () => {
            pasteArea.focus();
        });

        pasteArea.addEventListener('paste', (e) => {
            e.preventDefault();
            const items = e.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    handlePastedFile(file);
                    break;
                }
            }
        });

        pasteArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pasteArea.classList.add('paste-active');
        });

        pasteArea.addEventListener('dragleave', () => {
            pasteArea.classList.remove('paste-active');
        });

        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.classList.remove('paste-active');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('Vui lòng chọn file ảnh!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                currentImageType = 'file';
                imagePreview.src = currentImage;
                imagePreview.classList.remove('hidden');
                urlImagePreview.classList.add('hidden');
                pasteImagePreview.classList.add('hidden');
                processBtn.disabled = false;
                showMessage('Ảnh đã được tải lên thành công!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function handlePastedFile(file) {
            if (!file.type.startsWith('image/')) {
                showMessage('Dữ liệu dán không phải là ảnh!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                currentImageType = 'paste';
                pasteImagePreview.src = currentImage;
                pasteImagePreview.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                urlImagePreview.classList.add('hidden');
                processBtn.disabled = false;
                showMessage('Ảnh đã được dán thành công!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function loadImageFromUrl(url) {
            // Hiển thị trạng thái loading
            loadUrlBtn.disabled = true;
            loadUrlBtn.textContent = 'Đang tải...';
            
            // Tạo một ảnh mới để kiểm tra URL
            const img = new Image();
            img.onload = function() {
                currentImage = url;
                currentImageType = 'url';
                urlImagePreview.src = url;
                urlImagePreview.classList.remove('hidden');
                imagePreview.classList.add('hidden');
                pasteImagePreview.classList.add('hidden');
                processBtn.disabled = false;
                loadUrlBtn.disabled = false;
                loadUrlBtn.textContent = 'Tải ảnh từ URL';
                showMessage('Ảnh đã được tải thành công!', 'success');
            };
            img.onerror = function() {
                showMessage('Không thể tải ảnh từ URL. Vui lòng kiểm tra lại đường dẫn.', 'error');
                loadUrlBtn.disabled = false;
                loadUrlBtn.textContent = 'Tải ảnh từ URL';
            };
            img.src = url;
        }

        function processImage() {
            if (!currentImage) return;

            // Hiển thị loading
            loading.classList.remove('hidden');
            processBtn.disabled = true;

            // Gọi API thực tế
            fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: currentImage })
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.add('hidden');
                processBtn.disabled = false;
                
                if (data.error) {
                    showMessage('Lỗi: ' + data.error, 'error');
                } else {
                    // Thêm kết quả vào danh sách
                    allResults.push(data);
                    updateResultsTable();
                    
                    // Reset để chuẩn bị cho ảnh tiếp theo
                    resetImageInputs();
                    showMessage('Đã xử lý ảnh thành công!', 'success');
                }
            })
            .catch(error => {
                loading.classList.add('hidden');
                processBtn.disabled = false;
                showMessage('Lỗi kết nối: ' + error, 'error');
            });
        }

        function addMoreImages() {
            resetImageInputs();
            showMessage('Hãy tải lên ảnh CCCD tiếp theo', 'success');
        }

        function resetImageInputs() {
            currentImage = null;
            currentImageType = null;
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            urlImagePreview.src = '';
            urlImagePreview.classList.add('hidden');
            pasteImagePreview.src = '';
            pasteImagePreview.classList.add('hidden');
            urlInput.value = '';
            fileInput.value = '';
            processBtn.disabled = true;
        }

        function updateResultsTable() {
            // Xóa hàng "Chưa có kết quả" nếu có
            const noResultsRow = resultsTableBody.querySelector('.no-results');
            if (noResultsRow) {
                noResultsRow.remove();
            }
            
            // Xóa tất cả hàng hiện có và thêm lại
            resultsTableBody.innerHTML = '';
            
            allResults.forEach((result, index) => {
                const row = document.createElement('tr');
                
                // Tạo thumbnail ảnh có thể nhấp để xem toàn bộ
                const thumbnail = document.createElement('img');
                thumbnail.src = result.image_data || '';
                thumbnail.className = 'image-thumbnail';
                thumbnail.onclick = () => openImageModal(result.image_data || '');
                
                // Tạo checkbox để chọn mục
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'result-checkbox';
                checkbox.value = result.result_id;
                checkbox.onchange = updateSelectAllState;
                
                row.innerHTML = `
                    <td class="checkbox-cell"></td>
                    <td>${index + 1}</td>
                    <td></td> <!-- Placeholder for image thumbnail -->
                    <td>${result.id || 'Không xác định'}</td>
                    <td>${result.name || 'Không xác định'}</td>
                    <td>${result.dob || 'Không xác định'}</td>
                    <td>${result.sex || 'Không xác định'}</td>
                    <td>${result.nationality || 'Không xác định'}</td>
                    <td>${result.hometown || 'Không xác định'}</td>
                    <td>${result.address || 'Không xác định'}</td>
                    <td>${result.issue_date || 'Không xác định'}</td>
                    <td>${result.issue_place || 'Không xác định'}</td>
                `;
                
                // Thêm checkbox vào cột đầu tiên
                row.cells[0].appendChild(checkbox);
                
                // Thêm thumbnail vào cột thứ 3
                row.cells[2].appendChild(thumbnail);
                
                resultsTableBody.appendChild(row);
            });
            
            // Cập nhật trạng thái checkbox "Chọn tất cả"
            updateSelectAllState();
        }

        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.result-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.result-checkbox');
            const checkedCount = document.querySelectorAll('.result-checkbox:checked').length;
            
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        function getSelectedResultIds() {
            const checkboxes = document.querySelectorAll('.result-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
        }

        function openImageModal(imageSrc) {
            modalImage.src = imageSrc;
            imageModal.style.display = 'flex';
        }

        function closeModal() {
            imageModal.style.display = 'none';
        }

        // Đóng modal khi nhấp bên ngoài nội dung
        window.onclick = function(event) {
            if (event.target === imageModal) {
                closeModal();
            }
        }

        function copySelectedResults() {
            if (allResults.length === 0) {
                showMessage('Không có dữ liệu để sao chép', 'error');
                return;
            }
            
            const selectedIds = getSelectedResultIds();
            
            // Nếu không có mục nào được chọn, sao chép tất cả
            const idsToCopy = selectedIds.length > 0 ? selectedIds : allResults.map(r => r.result_id);
            
            fetch('/copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_ids: idsToCopy })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showMessage('Lỗi: ' + data.error, 'error');
                    return;
                }
                
                // Tạo chuỗi văn bản từ dữ liệu (chỉ nội dung, không có tiêu đề)
                let text = "";
                
                data.data.forEach(result => {
                    text += `${result["Số CCCD"]}\t${result["Họ và tên"]}\t${result["Ngày sinh"]}\t${result["Giới tính"]}\t${result["Quốc tịch"]}\t${result["Quê quán"]}\t${result["Địa chỉ"]}\t${result["Ngày cấp"]}\t${result["Nơi cấp"]}\n`;
                });
                
                navigator.clipboard.writeText(text)
                    .then(() => {
                        const count = data.data.length;
                        showMessage(`Đã sao chép ${count} kết quả!`, 'success');
                    })
                    .catch(err => showMessage('Lỗi sao chép: ' + err, 'error'));
            })
            .catch(error => {
                showMessage('Lỗi kết nối: ' + error, 'error');
            });
        }

        function clearAllResults() {
            if (allResults.length === 0) {
                showMessage('Không có kết quả để xóa', 'error');
                return;
            }
            
            if (confirm('Bạn có chắc chắn muốn xóa tất cả kết quả?')) {
                fetch('/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        allResults = [];
                        updateResultsTable();
                        
                        // Thêm lại hàng "Chưa có kết quả"
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="12" class="no-results">Chưa có kết quả nào. Hãy tải lên ảnh CCCD để bắt đầu.</td>';
                        resultsTableBody.appendChild(row);
                        
                        showMessage('Đã xóa tất cả kết quả!', 'success');
                    } else {
                        showMessage('Lỗi: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showMessage('Lỗi kết nối: ' + error, 'error');
                });
            }
        }

        function showMessage(message, type) {
            // Xóa thông báo cũ nếu có
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Tạo thông báo mới
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            // Thêm thông báo vào sau tiêu đề
            const container = document.querySelector('.container');
            const title = document.querySelector('h1');
            container.insertBefore(messageDiv, title.nextSibling);
            
            // Tự động xóa thông báo sau 3 giây
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // Tải lại kết quả khi trang được tải
        window.addEventListener('load', function() {
            fetch('/results')
                .then(response => response.json())
                .then(data => {
                    allResults = data;
                    updateResultsTable();
                })
                .catch(error => {
                    console.error('Lỗi khi tải kết quả:', error);
                });
        });
    </script>
</body>
</html>